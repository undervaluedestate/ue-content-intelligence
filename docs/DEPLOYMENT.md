# Deployment Guide

This guide walks you through deploying the Content Intelligence System to free cloud services.

## Architecture Overview

- **Backend**: Render (FastAPI + PostgreSQL + Redis + Cron Jobs)
- **Frontend**: Vercel (Next.js)
- **Email**: Resend (Free tier - 100 emails/day)
- **AI**: OpenAI API (Pay-per-use)

## Prerequisites

1. GitHub account (for connecting repos)
2. Render account (free): https://render.com
3. Vercel account (free): https://vercel.com
4. OpenAI API key: https://platform.openai.com
5. Resend API key (optional): https://resend.com
6. Twitter API access (optional): https://developer.twitter.com

---

## Part 1: Backend Deployment (Render)

### Step 1: Prepare Your Repository

1. Push your code to GitHub:
```bash
git init
git add .
git commit -m "Initial commit: Content Intelligence System"
git remote add origin https://github.com/yourusername/content-intelligence.git
git push -u origin main
```

### Step 2: Deploy to Render

1. Go to https://render.com and sign in
2. Click **"New +"** â†’ **"Blueprint"**
3. Connect your GitHub repository
4. Render will detect `render.yaml` and create:
   - Web Service (API)
   - PostgreSQL Database
   - Redis Instance
   - 2 Cron Jobs (Ingestion & Digest)

### Step 3: Configure Environment Variables

In the Render dashboard, go to your web service and add these environment variables:

**Required:**
- `OPENAI_API_KEY`: Your OpenAI API key
- `SECRET_KEY`: Auto-generated by Render
- `ADMIN_EMAIL`: Your admin email (e.g., admin@yourdomain.com)
- `DIGEST_RECIPIENTS`: Comma-separated emails (e.g., team@domain.com,founder@domain.com)

**Optional (for Twitter ingestion):**
- `TWITTER_BEARER_TOKEN`: Your Twitter API bearer token
- `TWITTER_API_KEY`: Your Twitter API key
- `TWITTER_API_SECRET`: Your Twitter API secret
- `TWITTER_ACCESS_TOKEN`: Your Twitter access token
- `TWITTER_ACCESS_SECRET`: Your Twitter access secret

**Optional (for email digest):**
- `RESEND_API_KEY`: Your Resend API key

**Frontend CORS:**
- `CORS_ORIGINS`: Update with your Vercel URL once deployed

### Step 4: Wait for Deployment

Render will:
1. Install dependencies
2. Create database tables
3. Start the API server
4. Schedule cron jobs

Your API will be available at: `https://your-app-name.onrender.com`

### Step 5: Test the API

Visit: `https://your-app-name.onrender.com/docs`

You should see the FastAPI interactive documentation.

---

## Part 2: Frontend Deployment (Vercel)

### Step 1: Deploy to Vercel

1. Go to https://vercel.com and sign in
2. Click **"Add New"** â†’ **"Project"**
3. Import your GitHub repository
4. Configure:
   - **Framework Preset**: Next.js
   - **Root Directory**: `frontend`
   - **Build Command**: `npm run build`
   - **Output Directory**: `.next`

### Step 2: Configure Environment Variables

Add this environment variable in Vercel:

- `NEXT_PUBLIC_API_URL`: Your Render backend URL (e.g., `https://your-app-name.onrender.com/api/v1`)

### Step 3: Deploy

Click **"Deploy"** and wait for the build to complete.

Your dashboard will be available at: `https://your-app-name.vercel.app`

### Step 4: Update Backend CORS

Go back to Render and update the `CORS_ORIGINS` environment variable:

```
CORS_ORIGINS=https://your-app-name.vercel.app,http://localhost:3000
```

Redeploy the backend for changes to take effect.

---

## Part 3: Initial Setup

### Step 1: Add Whitelisted Twitter Accounts

Use the API to add Twitter accounts to monitor:

```bash
curl -X POST https://your-app-name.onrender.com/api/v1/trends/ingest
```

Or use the Python client:

```python
from app.services.ingestion.trend_ingestion import TrendIngestionService
from app.core.database import SessionLocal

db = SessionLocal()
service = TrendIngestionService(db)

# Add whitelisted accounts
await service.add_whitelisted_account(
    platform="twitter",
    username="BudgITng",  # Example: Nigerian budget transparency org
    category="policy",
    priority=2
)

await service.add_whitelisted_account(
    platform="twitter",
    username="NigeriaPropertyCentre",
    category="real_estate",
    priority=3
)
```

### Step 2: Trigger First Ingestion

Manually trigger the first ingestion cycle:

```bash
curl -X POST https://your-app-name.onrender.com/api/v1/trends/ingest
curl -X POST https://your-app-name.onrender.com/api/v1/trends/score
curl -X POST https://your-app-name.onrender.com/api/v1/content/generate?limit=5
```

### Step 3: Access Dashboard

Visit your Vercel URL and you should see:
- Dashboard with stats
- Pending content for review
- Trends that passed filters

---

## Part 4: Ongoing Operations

### Automated Schedule

The system runs automatically:

1. **Every 2 hours**: Ingestion pipeline runs
   - Ingests trends from Twitter/Google News
   - Scores trends for relevance and risk
   - Generates content for top trends

2. **Daily at 8am (Lagos time)**: Email digest sent
   - Sends pending content to review team
   - Includes clickable approve/reject actions

### Manual Triggers

You can manually trigger jobs from the dashboard or API:

- **Ingest trends**: `POST /api/v1/trends/ingest`
- **Score trends**: `POST /api/v1/trends/score`
- **Generate content**: `POST /api/v1/content/generate?limit=5`

### Monitoring

- **Render Logs**: View logs in Render dashboard
- **API Health**: `GET https://your-app-name.onrender.com/health`
- **Stats**: `GET https://your-app-name.onrender.com/api/v1/stats`

---

## Part 5: Cost Breakdown (Free Tier Limits)

### Render (Free)
- âœ… Web service: 750 hours/month (always on)
- âœ… PostgreSQL: 90 days free, then $7/month
- âœ… Redis: 25MB storage
- âœ… Cron jobs: Unlimited

### Vercel (Free)
- âœ… 100GB bandwidth/month
- âœ… Unlimited deployments
- âœ… Custom domains

### Resend (Free)
- âœ… 100 emails/day
- âœ… 3,000 emails/month

### OpenAI (Pay-per-use)
- GPT-4 Turbo: ~$0.01-0.03 per content piece
- Estimated: $5-15/month for 500 content pieces

**Total Monthly Cost**: ~$7-22 (after PostgreSQL free trial)

---

## Part 6: Scaling Beyond Free Tier

When you outgrow free tiers:

### Option 1: Upgrade Render
- PostgreSQL: $7/month (256MB RAM)
- Redis: $10/month (100MB)
- Web service: $7/month (512MB RAM)

### Option 2: Migrate to Supabase
- PostgreSQL + Redis: Free up to 500MB
- Longer free tier than Render

### Option 3: Self-host
- Use Railway, Fly.io, or DigitalOcean
- More control, similar pricing

---

## Troubleshooting

### Backend won't start
- Check environment variables are set
- View logs in Render dashboard
- Ensure DATABASE_URL is correct

### Frontend can't connect to backend
- Verify NEXT_PUBLIC_API_URL is correct
- Check CORS_ORIGINS includes your Vercel URL
- Test API directly: `curl https://your-backend.onrender.com/health`

### No trends being ingested
- Check Twitter API credentials
- Verify cron jobs are running in Render
- Manually trigger: `POST /api/v1/trends/ingest`

### Email digest not sending
- Verify RESEND_API_KEY is set
- Check DIGEST_RECIPIENTS is correct
- View cron job logs in Render

---

## Security Checklist

- âœ… Never commit `.env` files
- âœ… Use environment variables for all secrets
- âœ… Rotate API keys regularly
- âœ… Enable HTTPS only (automatic on Render/Vercel)
- âœ… Review audit logs regularly
- âœ… Limit CORS origins to your domains only

---

## Support

For issues or questions:
1. Check logs in Render/Vercel dashboards
2. Review API documentation: `/docs` endpoint
3. Check GitHub issues
4. Contact development team

---

**Deployment complete! ðŸŽ‰**

Your Content Intelligence System is now live and running on free cloud infrastructure.
