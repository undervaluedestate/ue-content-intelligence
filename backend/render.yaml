services:
  # Web Service - FastAPI Backend
  - type: web
    name: content-intelligence-api
    env: python
    region: oregon
    plan: free
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn main:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: APP_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: content-intelligence-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: content-intelligence-redis
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
      - key: OPENAI_API_KEY
        sync: false
      - key: TWITTER_BEARER_TOKEN
        sync: false
      - key: RESEND_API_KEY
        sync: false
      - key: ADMIN_EMAIL
        sync: false
      - key: DIGEST_RECIPIENTS
        sync: false
      - key: CORS_ORIGINS
        value: https://your-frontend.vercel.app,http://localhost:3000

  # Cron Job - Ingestion Pipeline (runs every 2 hours)
  - type: cron
    name: content-intelligence-ingestion
    env: python
    region: oregon
    plan: free
    schedule: "0 */2 * * *"
    buildCommand: pip install -r requirements.txt
    startCommand: python -c "from app.workers.scheduled_jobs import ingestion_job; ingestion_job()"
    envVars:
      - key: APP_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: content-intelligence-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: content-intelligence-redis
          property: connectionString
      - key: OPENAI_API_KEY
        sync: false
      - key: TWITTER_BEARER_TOKEN
        sync: false

  # Cron Job - Daily Digest (runs at 8am daily)
  - type: cron
    name: content-intelligence-digest
    env: python
    region: oregon
    plan: free
    schedule: "0 8 * * *"
    buildCommand: pip install -r requirements.txt
    startCommand: python -c "from app.workers.scheduled_jobs import digest_job; digest_job()"
    envVars:
      - key: APP_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: content-intelligence-db
          property: connectionString
      - key: RESEND_API_KEY
        sync: false
      - key: ADMIN_EMAIL
        sync: false
      - key: DIGEST_RECIPIENTS
        sync: false

databases:
  - name: content-intelligence-db
    databaseName: content_intelligence
    plan: free
    region: oregon

  - name: content-intelligence-redis
    plan: free
    region: oregon
